<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ProgTime 2022</title>
</head>
<body>
    <ol id="task_list">

    </ol>
    <h1 id="header">Задача 1</h1>
    <p id="description">
        Описание
    </p>
    <textarea id="code" spellcheck="false" class="text">print('Hello, world!')</textarea>
    <button onclick="send_task()" id="run" disabled="disabled">Run</button>
    <textarea id="output" spellcheck="false" readonly="readonly" class="text"></textarea>

    <script>
        document.getElementById('run').disabled = true
        let tasks
        let task_id
        async function load_task(new_task_id) {
            for (let task of tasks) {
                if (task.id == new_task_id) {
                    document.getElementById('header').textContent = task['name']
                    document.getElementById('description').textContent = task['description']
                    document.getElementById('run').disabled = false
                    task_id = task['id']
                    return
                }
            }
        }

        async function load_tasks() {
            let token = localStorage.getItem('token')
            let response = await fetch('/api/get_tasks', {
                method: 'GET',
                headers: {
                    'Authorization': token
                },
            });
            tasks = await response.json()


            let task_list = document.getElementById('task_list')
            for (let i = 0; i < tasks.length; i++) {
                let li = document.createElement('li')
                let task = tasks[i]
                li.textContent = task['name']
                li.onclick = () => load_task(task['id'])
                task_list.appendChild(li)
            }
        }
        load_tasks()

        async function send_task() {
            let token = localStorage.getItem('token')
            let code = document.getElementById('code').value
                let response = await fetch('/api/send_task', {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'task_id': task_id,
                        'code': code
                    })
                })
            let result = await response.json()
            document.getElementById('output').value = JSON.stringify(result['result'])
        }
    </script>
</body>
</html>